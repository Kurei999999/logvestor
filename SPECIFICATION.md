# 投資記録管理アプリケーション仕様書

## 1. プロジェクト概要

### 1.1 アプリケーション名
Trade Journal Local

### 1.2 コンセプト
Obsidianのようなローカルファイルベースの投資記録管理システム。完全オフラインで動作し、プライバシーとセキュリティを重視したデスクトップアプリケーション。

### 1.3 主要機能
- ローカルマークダウンファイルでの投資記録管理
- 買い/売りのチャート画像を含む視覚的な記録
- CSV/Excelファイルでのポートフォリオ管理
- 画像一覧表示（グリッド/タイムライン切り替え可能）
- 高度なフィルタリング・集計機能
- 柔軟なCSVビューア/エディタ（マッピング不要）

## 2. 技術スタック

### 2.1 フロントエンド
- **Next.js 15.3.5** (App Router) ✅ 実装済み
- **TypeScript 5** - 型安全性確保（strict mode有効）
- **Tailwind CSS 4.0+** - 最新のユーティリティファーストCSS
- **Shadcn/ui** (UIコンポーネント) - アクセシブルなReactコンポーネント

### 2.2 デスクトップ化 ✅ 実装済み
- **Electron 33.3.2** - セキュリティ強化とパフォーマンス改善
- **electron-builder** (パッケージング設定済み)

### 2.3 ライブラリ
- **@tanstack/react-table** (データテーブル) - 最新のテーブル管理
- **recharts** (グラフ表示) - React向けチャートライブラリ
- **react-markdown** (マークダウンレンダリング)
- **date-fns** (日付処理) - 軽量な日付ライブラリ
- **papaparse** (CSV処理) - 高速なCSVパーサー
- **exceljs** (Excel処理) - Excel読み書き対応

## 3. ディレクトリ構造

### 3.1 アプリケーション構造
```
trade-journal-local/
├── app/                    # Next.js App Router
│   ├── (main)/
│   │   ├── dashboard/     # ダッシュボード
│   │   ├── trades/        # トレード一覧・詳細
│   │   ├── gallery/       # 画像ギャラリー
│   │   ├── analytics/     # 分析・集計
│   │   ├── csv-viewer/    # CSVビューア/エディタ ✅ 実装済み
│   │   ├── import/        # CSVインポート画面
│   │   └── settings/      # 設定画面 ✅ 実装済み
│   └── api/               # Electron IPC通信用
├── components/
│   ├── ui/                # Shadcn/ui components
│   ├── trade/
│   ├── gallery/
│   ├── analytics/
│   ├── csv-viewer/        # CSVビューア関連コンポーネント ✅ 実装済み
│   ├── markdown/          # Markdownエディタコンポーネント ✅ 実装済み
│   └── migration/         # 移行ツールコンポーネント ✅ 実装済み
├── electron/              # Electronメインプロセス ✅ 実装済み
│   ├── main.js           # メインプロセスエントリポイント
│   ├── preload.js        # contextBridge付きプリロードスクリプト
│   └── ipc-handlers.js   # IPCイベントハンドラー
├── lib/
│   ├── file-system/       # ファイル操作
│   ├── trade-folder/      # トレードフォルダ管理 ✅ 実装済み
│   ├── csv/               # CSV管理 ✅ 実装済み
│   ├── services/          # アプリケーションサービス ✅ 実装済み
│   ├── hooks/             # React hooks ✅ 実装済み
│   ├── migration/         # データ移行ツール ✅ 実装済み
│   ├── parsers/           # CSV/Excel/MD解析
│   ├── csv-mapper/        # CSVマッピング処理
│   ├── trade-linker/      # CSV-MD紐付けロジック
│   ├── trade-filters/     # フィルタープリセット管理
│   └── utils/             # ユーティリティ
└── types/
    ├── trade.ts           # Trade関連型定義
    ├── csv.ts             # CSV型定義
    └── csv-viewer.ts      # CSVビューア型定義 ✅ 実装済み
```

### 3.2 ユーザーデータ構造（Issue #21対応 ✅ 完了）
```
~/TradeJournal/            # デフォルト保存場所（ユーザーが変更可能）
├── trades.csv             # 統合取引データ（分析用）
├── trades/
│   ├── 2024/              # 年別フォルダ
│   │   ├── AAPL_01-15_001/     # {ticker}_{MM-DD}_{sequence}
│   │   │   ├── entry_analysis.md
│   │   │   ├── technical_memo.md
│   │   │   ├── followup_notes.md
│   │   │   └── images/
│   │   │       ├── chart_entry_1.png
│   │   │       ├── chart_entry_2.png
│   │   │       └── pattern_analysis.png
│   │   ├── AAPL_01-15_002/     # 同日の2回目の取引
│   │   │   ├── exit_analysis.md
│   │   │   ├── reflection.md
│   │   │   └── images/
│   │   └── MSFT_02-01_001/
│   │       ├── swing_trade.md
│   │       └── images/
│   └── 2025/              # 年が変わると新しいフォルダ
│       └── AAPL_01-03_001/
├── portfolio/
│   ├── positions.csv      # 現在のポジション
│   ├── history.csv        # 取引履歴
│   └── watchlist.csv      # ウォッチリスト
├── templates/
│   ├── trade_buy.md       # 買いテンプレート
│   ├── trade_sell.md      # 売りテンプレート
│   └── analysis.md        # 分析テンプレート
└── .tradejournalrc        # アプリ設定ファイル
```

**主な変更点（Issue #21）:**
- 保存場所: `~/Documents/TradeJournal/` → `~/TradeJournal/`
- フォルダ構造: 年別管理で月/日フォルダ廃止
- 命名規則: `{ticker}_{MM-DD}_{sequence}` (例: `AAPL_01-15_001`)
- 連番システム: 同一銘柄・同日の複数取引に自動採番
- 統合CSV: `trades.csv`で全取引データを一元管理

## 4. 機能詳細

### 4.1 トレード記録機能
- **新規記録作成**
  - テンプレートからの作成
  - CSVの選択した行から基本情報を取得
  - 「メモを追加」ボタンで新規マークダウン作成
  - 同一取引に複数のメモファイルを追加可能
  - ドラッグ&ドロップでの画像追加
  - マークダウンエディタでの詳細記述

- **記録管理**
  - フォルダ構造での整理（取引ごとにサブフォルダ）
  - 1つの取引フォルダ内に複数のマークダウンファイル保存
  - タグ・カテゴリ管理
  - 検索機能（全文検索対応）

- **高度な検索・フィルタリング機能**
  - 全フィールド対象の全文検索（ティッカー、価格、数量、P&L、タグ等）
  - デバウンス付き検索（300ms遅延でパフォーマンス最適化）
  - 日付範囲フィルター
  - 数量範囲フィルター
  - P&L範囲フィルター
  - P&Lカテゴリーフィルター（利益/損失/収支均衡）
  - 複数カラムでのソート（日付、ティッカー、P&L、数量、価格、手数料）

- **フィルタープリセット機能**
  - よく使うフィルター組み合わせの保存
  - デフォルトプリセット（利益取引、損失取引、大口取引、直近取引）
  - プリセットの管理（作成、適用、削除）

- **バルク操作**
  - 複数取引の一括選択
  - 一括削除（確認ダイアログ付き）
  - 一括CSVエクスポート

### 4.2 画像ギャラリー機能
- **表示モード**
  - グリッドビュー（サムネイル一覧）
  - タイムラインビュー（時系列表示）
  - ペアビュー（買い/売りを並べて表示）

- **フィルタリング**
  - 期間指定
  - 銘柄フィルタ
  - 損益別（利益/損失）
  - タグフィルタ

### 4.3 ポートフォリオ管理
- **CSV/Excelファイル連携**
  - positions.csv: 銘柄、数量、平均取得価格、現在価格
  - history.csv: 日付、銘柄、売買、数量、価格、手数料、損益
  - カスタムフィールド対応

- **データインポート/エクスポート**
  - カスタムフォーマット対応
  - ユーザーの既存CSVファイルの直接インポート
  - CSVカラムマッピング機能（異なるフォーマットに対応）

- **CSVとマークダウンの紐付け機能**
  - CSVの各行に対して複数のマークダウンファイルを手動で紐付け可能
  - ユーザーがボタンを押して新規マークダウンを作成・追加
  - 1つの取引に対して複数のメモ・分析ファイルを関連付け可能
  - 既存のマークダウンファイルとの関連付け
  - 紐付けは手動で管理（自動生成なし）

### 4.4 分析・集計機能
- **パフォーマンス分析**
  - 期間別損益
  - 銘柄別パフォーマンス
  - 勝率・リスクリワード比

- **ビジュアライゼーション**
  - 損益推移グラフ
  - ポートフォリオ構成
  - ヒートマップ

### 4.5 CSVビューア/エディタ機能 ✅ 実装済み
- **柔軟なCSVデータ管理**
  - マッピング設定不要で任意のCSVファイルを即座に表示
  - Excelライクなテーブルビューで直感的な操作
  - セルのクリック編集（インライン編集）
  - 行・列の動的な追加・削除

- **データ管理機能**
  - 複数のCSV文書を管理
  - ドキュメント検索機能
  - ファイル名ベースの整理
  - LocalStorageでの永続化

- **エクスポート機能**
  - CSV形式でのダウンロード
  - JSON形式でのダウンロード
  - 元ファイル名保持

- **ソート・表示機能**
  - カラムヘッダークリックでソート
  - 昇順・降順切り替え
  - カラム別の表示調整

- **ストレージ管理**
  - 使用量モニタリング
  - ストレージ制限表示（10MB）
  - 容量不足時の警告

**用途:**
- データ探索（CSVファイルの構造確認）
- 一般的なスプレッドシート操作
- 投資以外のデータ管理
- マッピング設定なしの簡単CSV編集

### 4.6 設定・カスタマイズ ✅ 実装済み
- データ保存場所の指定
- テンプレートのカスタマイズ
- CSVフィールドマッピング
- ショートカットキー設定

## 5. データ形式

### 5.1 マークダウンファイル形式
```markdown
---
date: 2024-01-15
ticker: AAPL
action: buy
quantity: 100
price: 185.50
tags: [テクノロジー, 長期投資]
---

# AAPL 買いエントリー

## エントリー理由
- サポートラインでの反発
- 出来高増加

## テクニカル分析
![チャート分析](./images/chart_entry.png)

## ファンダメンタル
- 新製品発表予定
- 業績好調

## リスク管理
- ストップロス: $180
- 目標価格: $200
```

### 5.2 CSV形式
#### 標準形式（history.csv）
```csv
trade_id,date,ticker,action,quantity,price,commission,pnl,notes_files
T001,2024-01-15,AAPL,buy,100,185.50,10.00,,trades/2024/AAPL_01-15_001/entry_analysis.md
T002,2024-01-20,AAPL,sell,100,190.00,10.00,430.00,trades/2024/AAPL_01-15_001/exit_analysis.md
```

#### ユーザーCSVマッピング例
```json
{
  "columnMapping": {
    "date": "取引日",
    "ticker": "銘柄コード", 
    "action": "売買区分",
    "quantity": "数量",
    "price": "約定単価",
    "commission": "手数料",
    "pnl": "実現損益"
  },
  "dateFormat": "YYYY/MM/DD",
  "actionMapping": {
    "buy": ["買い", "現物買", "信用新規買"],
    "sell": ["売り", "現物売", "信用返済売"]
  }
}
```

## 6. セキュリティ・プライバシー

### 6.1 データ保護
- 完全オフライン動作
- ローカルファイルのみ使用
- 外部API通信なし（オプションで有効化可能）

### 6.2 バックアップ
- 自動バックアップ機能
- Git連携対応（オプション）
- 暗号化エクスポート

## 7. 開発ロードマップ

### Phase 1: MVP (2-3週間) ✅ 完了
- [x] Electronセットアップ
- [x] 基本的なファイル操作
- [x] CSVインポート・マッピング機能
- [x] CSV-マークダウン紐付け機能
- [x] マークダウンエディタ
- [x] 画像ギャラリー（グリッドビュー）
- [x] CSV読み書き
- [x] 高度なフィルタリング機能
- [x] バルク操作機能
- [x] 分析ダッシュボード（GitHub Issue #1）
- [x] UI/UX改善（GitHub Issue #4）
- [x] バグ修正：ギャラリーページの無限再レンダリング（GitHub Issue #8）

### Phase 2: 機能拡張 (2-3週間) ✅ 完了
- [x] 高度なフィルタリング（Phase 1で実装済み）
- [x] 集計・分析機能
- [x] タイムラインビュー
- [x] ファイルシステムAPI抽象化（GitHub Issue #5）
- [x] IPC通信レイヤー設計（GitHub Issue #6）

### Phase 3: 最適化 (1-2週間) ✅ Electron統合完了
- [x] Electron統合とデスクトップ機能（GitHub Issue #7）
- [x] UI/UX改善
- [x] 設定画面
- [ ] パフォーマンス最適化
- [ ] 自動バックアップ（GitHub Issue #3 - 進行中）

### Phase 4: CSV管理機能拡張 (1週間) ✅ 完了
- [x] CSVビューア/エディタ機能（GitHub Issue #15）
- [x] 柔軟なCSVデータ管理（マッピング不要）
- [x] Excelライクな編集機能
- [x] CSV文書管理システム
- [x] エクスポート機能（CSV/JSON）
- [x] ストレージ管理機能
- [x] Enhanced Trade Import（GitHub Issue #16）
- [x] Trade型データ構造変更（取引ベース）
- [x] 自動P&L計算機能
- [x] CSVエディタ統合機能

### Phase 5: Markdownメモ統合 (1週間) ✅ 完了
- [x] Markdown Memo Integration（GitHub Issue #19）
- [x] ローカルファイルベースのメモ機能
- [x] Trade行からのドロップダウンメニュー
- [x] 右側パネルMarkdownエディタ
- [x] VSCode-like自動リロード機能
- [x] ファイルシステム直接アクセス

### Phase 6: データ構造再編成 (1週間) ✅ 100%完了
- [x] **Trade Data Structure Restructuring（GitHub Issue #21 - ✅ COMPLETE）**
- [x] 日付ベースフォルダ階層の実装
- [x] 連番システムによる同日複数取引対応
- [x] デフォルト保存場所変更（Documents → ホーム直下）
- [x] パス生成ユーティリティの実装
- [x] コンポーネント統合とTypeScript型安全性向上
- [x] 統合CSV管理システムの完全実装
- [x] 中央trades.csvファイル: 全取引データの一元管理
- [x] TradeDataService: CSVサービスとアプリケーション間のブリッジ
- [x] useTradeDataフック: Reactコンポーネント統合
- [x] 自動マイグレーション: LocalStorageから中央CSVへの移行
- [x] エラーハンドリング: LocalStorageフォールバック機能
- [x] データ移行ツール
- [x] DataMigrationService: 旧フォルダ構造からの移行ユーティリティ
- [x] データ検証・修復機能: 整合性チェックとクリーンアップツール
- [x] バックアップシステム: 移行前の自動バックアップ作成
- [x] 設定ページ: ユーザーフレンドリーな管理インターフェース

## 8. 非機能要件

### 8.1 パフォーマンス
- 10,000件の取引記録で快適動作
- 画像サムネイルの遅延読み込み
- インデックス化による高速検索

### 8.2 対応OS
- Windows 10+
- macOS 10.15+
- Linux (Ubuntu 20.04+)

### 8.3 ハードウェア要件
- RAM: 4GB以上推奨
- ストレージ: アプリ本体100MB + ユーザーデータ

## 9. 現在の実装状況

### 実装済み機能
- ✅ Electron統合（デスクトップアプリ化）
- ✅ セキュアなIPC通信レイヤー
- ✅ ファイルシステムAPI抽象化
- ✅ CSVインポート・表示機能
- ✅ 高度なフィルタリング・検索機能
- ✅ フィルタープリセット管理
- ✅ バルク操作（一括選択・削除・エクスポート）
- ✅ 分析ダッシュボード（チャート、統計情報）
- ✅ 画像ギャラリー（グリッドビュー）
- ✅ レスポンシブUI/UX
- ✅ **CSVビューア/エディタ**（Issue #15）
- ✅ **Enhanced Trade Import**（Issue #16）
- ✅ **Markdown Memo Integration**（Issue #19）
- ✅ **Trade Data Structure Restructuring**（Issue #21 - ✅ 100%完了）

### 未実装機能
- ⏳ 自動バックアップ機能（Issue #3で進行中）
- ⏳ パフォーマンス最適化

## 10. 将来的な拡張案
- プラグインシステム
- クラウド同期（オプション）
- モバイルビューア
- AIによる取引分析（ローカルLLM）
- 仮想通貨・FX対応