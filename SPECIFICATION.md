# 投資記録管理アプリケーション仕様書

## 1. プロジェクト概要

### 1.1 アプリケーション名

Trade Journal Local (仮)

### 1.2 コンセプト

Obsidian のようなローカルファイルベースの投資記録管理システム。完全オフラインで動作し、プライバシーとセキュリティを重視したデスクトップアプリケーション。

### 1.3 主要機能

- ローカルマークダウンファイルでの投資記録管理
- 買い/売りのチャート画像を含む視覚的な記録
- CSV/Excel ファイルでのポートフォリオ管理
- 画像一覧表示（グリッド/タイムライン切り替え可能）
- 高度なフィルタリング・集計機能
- 柔軟なCSVビューア/エディタ（マッピング不要）

## 2. 技術スタック

### 2.1 フロントエンド

- **Next.js 15.3.5** (App Router) - 実装済み
- **TypeScript 5** - 型安全性確保（strict mode 有効）
- **Tailwind CSS 4.0+** - 最新のユーティリティファースト CSS
- **Shadcn/ui** (UI コンポーネント) - アクセシブルな React コンポーネント

### 2.2 デスクトップ化 ✅ 実装済み

- **Electron 33.3.2** - セキュリティ強化とパフォーマンス改善
- **electron-builder** (パッケージング設定済み)

### 2.3 ライブラリ

- **@tanstack/react-table** (データテーブル) - 最新のテーブル管理
- **recharts** (グラフ表示) - React 向けチャートライブラリ
- **react-markdown** (マークダウンレンダリング)
- **date-fns** (日付処理) - 軽量な日付ライブラリ
- **papaparse** (CSV 処理) - 高速な CSV パーサー
- **exceljs** (Excel 処理) - Excel 読み書き対応

## 3. ディレクトリ構造

### 3.1 アプリケーション構造

```
trade-journal-local/
├── app/                    # Next.js App Router
│   ├── (main)/
│   │   ├── dashboard/     # ダッシュボード
│   │   ├── trades/        # トレード一覧・詳細
│   │   ├── gallery/       # 画像ギャラリー
│   │   ├── analytics/     # 分析・集計
│   │   ├── csv-viewer/    # CSV ビューア/エディタ ✅ 実装済み
│   │   └── import/        # CSVインポート画面
│   └── api/               # Electron IPC通信用
├── components/
│   ├── ui/                # Shadcn/ui components
│   ├── trade/
│   ├── gallery/
│   ├── analytics/
│   └── csv-viewer/        # CSV ビューア関連コンポーネント ✅ 実装済み
├── electron/              # Electronメインプロセス ✅ 実装済み
│   ├── main.js           # メインプロセスエントリポイント
│   ├── preload.js        # contextBridge付きプリロードスクリプト
│   └── ipc-handlers.js   # IPCイベントハンドラー
├── lib/
│   ├── file-system/       # ファイル操作
│   │   └── csv-storage.ts # CSV文書ストレージ ✅ 実装済み
│   ├── parsers/           # CSV/Excel/MD解析
│   ├── csv-mapper/        # CSVマッピング処理
│   ├── trade-linker/      # CSV-MD紐付けロジック
│   └── utils/
└── types/
    ├── trade.ts           # Trade関連型定義
    ├── csv.ts             # レガシーCSVインポート型
    └── csv-viewer.ts      # CSVビューア型定義 ✅ 実装済み
```

### 3.2 ユーザーデータ構造（推奨）

```
~/Documents/TradeJournal/  # ユーザーが変更可能
├── trades/
│   ├── 2024/
│   │   ├── 01/
│   │   │   ├── T001_AAPL_買い/
│   │   │   │   ├── entry_analysis.md
│   │   │   │   ├── technical_memo.md
│   │   │   │   ├── followup_20240116.md
│   │   │   │   └── images/
│   │   │   │       ├── chart_entry_1.png
│   │   │   │       ├── chart_entry_2.png
│   │   │   │       └── pattern_analysis.png
│   │   │   └── T002_AAPL_売り/
│   │   │       ├── exit_analysis.md
│   │   │       ├── reflection.md
│   │   │       └── images/
│   │   └── 02/
│   └── 2025/
├── portfolio/
│   ├── positions.csv      # 現在のポジション
│   ├── history.csv        # 取引履歴
│   └── watchlist.csv      # ウォッチリスト
├── templates/
│   ├── trade_buy.md       # 買いテンプレート
│   ├── trade_sell.md      # 売りテンプレート
│   └── analysis.md        # 分析テンプレート
└── .tradejournalrc        # アプリ設定ファイル
```

## 4. 機能詳細

### 4.1 トレード記録機能

- **新規記録作成**

  - テンプレートからの作成
  - CSV の選択した行から基本情報を取得
  - 「メモを追加」ボタンで新規マークダウン作成
  - 同一取引に複数のメモファイルを追加可能
  - ドラッグ&ドロップでの画像追加
  - マークダウンエディタでの詳細記述

- **記録管理**

  - フォルダ構造での整理（取引ごとにサブフォルダ）
  - 1 つの取引フォルダ内に複数のマークダウンファイル保存
  - タグ・カテゴリ管理
  - 検索機能（全文検索対応）

- **高度な検索・フィルタリング機能**

  - 全フィールド対象の全文検索（ティッカー、価格、数量、P&L、タグ等）
  - デバウンス付き検索（300ms 遅延でパフォーマンス最適化）
  - 日付範囲フィルター
  - 数量範囲フィルター
  - P&L 範囲フィルター
  - P&L カテゴリーフィルター（利益/損失/収支均衡）
  - 複数カラムでのソート（日付、ティッカー、P&L、数量、価格、手数料）

- **フィルタープリセット機能**

  - よく使うフィルター組み合わせの保存
  - デフォルトプリセット（利益取引、損失取引、大口取引、直近取引）
  - プリセットの管理（作成、適用、削除）

- **バルク操作**
  - 複数取引の一括選択
  - 一括削除（確認ダイアログ付き）
  - 一括 CSV エクスポート

### 4.2 画像ギャラリー機能

- **表示モード**

  - グリッドビュー（サムネイル一覧）
  - タイムラインビュー（時系列表示）
  - ペアビュー（買い/売りを並べて表示）

- **フィルタリング**
  - 期間指定
  - 銘柄フィルタ
  - 損益別（利益/損失）
  - タグフィルタ

### 4.3 ポートフォリオ管理

- **CSV/Excel ファイル連携**

  - positions.csv: 銘柄、数量、平均取得価格、現在価格
  - history.csv: 日付、銘柄、売買、数量、価格、手数料、損益
  - カスタムフィールド対応

- **データインポート/エクスポート**

  - カスタムフォーマット対応
  - **ユーザーの既存 CSV ファイルの直接インポート**
  - **CSV カラムマッピング機能**（異なるフォーマットに対応）

- **CSV とマークダウンの紐付け機能**
  - CSV の各行に対して複数のマークダウンファイルを手動で紐付け可能
  - ユーザーがボタンを押して新規マークダウンを作成・追加
  - 1 つの取引に対して複数のメモ・分析ファイルを関連付け可能
  - 既存のマークダウンファイルとの関連付け
  - 紐付けは手動で管理（自動生成なし）

### 4.4 分析・集計機能

- **パフォーマンス分析**

  - 期間別損益
  - 銘柄別パフォーマンス
  - 勝率・リスクリワード比

- **ビジュアライゼーション**
  - 損益推移グラフ
  - ポートフォリオ構成
  - ヒートマップ

### 4.5 CSV ビューア/エディタ機能 ✅ 実装済み

- **柔軟なCSVデータ管理**
  - マッピング設定不要で任意のCSVファイルを即座に表示
  - Excelライクなテーブルビューで直感的な操作
  - セルのクリック編集（インライン編集）
  - 行・列の動的な追加・削除

- **データ管理機能**
  - 複数のCSV文書を管理
  - ドキュメント検索機能
  - ファイル名ベースの整理
  - LocalStorageでの永続化

- **エクスポート機能**
  - CSV形式でのダウンロード
  - JSON形式でのダウンロード
  - 元ファイル名保持

- **ソート・表示機能**
  - カラムヘッダークリックでソート
  - 昇順・降順切り替え
  - カラム別の表示調整

- **ストレージ管理**
  - 使用量モニタリング
  - ストレージ制限表示（10MB）
  - 容量不足時の警告

**用途:**
- データ探索（CSVファイルの構造確認）
- 一般的なスプレッドシート操作
- 投資以外のデータ管理
- マッピング設定なしの簡単CSV編集

### 4.6 設定・カスタマイズ

- **データ保存場所の指定**
- **テンプレートのカスタマイズ**
- **CSV フィールドマッピング**
- **ショートカットキー設定**

## 5. データ形式

### 5.1 マークダウンファイル形式

```markdown
---
date: 2024-01-15
ticker: AAPL
action: buy
quantity: 100
price: 185.50
tags: [テクノロジー, 長期投資]
---

# AAPL 買いエントリー

## エントリー理由

- サポートラインでの反発
- 出来高増加

## テクニカル分析

![チャート分析](./images/chart_entry.png)

## ファンダメンタル

- 新製品発表予定
- 業績好調

## リスク管理

- ストップロス: $180
- 目標価格: $200
```

### 5.2 CSV 形式

#### 標準形式（history.csv）

```csv
trade_id,date,ticker,action,quantity,price,commission,pnl,notes_files
T001,2024-01-15,AAPL,buy,100,185.50,10.00,,"trades/2024/01/T001_AAPL_買い/entry_analysis.md,trades/2024/01/T001_AAPL_買い/technical_memo.md"
T002,2024-01-20,AAPL,sell,100,190.00,10.00,430.00,"trades/2024/01/T002_AAPL_売り/exit_analysis.md,trades/2024/01/T002_AAPL_売り/reflection.md"
```

#### ユーザー CSV マッピング例

```json
{
  "columnMapping": {
    "date": "取引日",
    "ticker": "銘柄コード",
    "action": "売買区分",
    "quantity": "数量",
    "price": "約定単価",
    "commission": "手数料",
    "pnl": "実現損益"
  },
  "dateFormat": "YYYY/MM/DD",
  "actionMapping": {
    "buy": ["買い", "現物買", "信用新規買"],
    "sell": ["売り", "現物売", "信用返済売"]
  }
}
```

## 6. セキュリティ・プライバシー

### 6.1 データ保護

- 完全オフライン動作
- ローカルファイルのみ使用
- 外部 API 通信なし（オプションで有効化可能）

### 6.2 バックアップ

- 自動バックアップ機能
- Git 連携対応（オプション）
- 暗号化エクスポート

## 7. 開発ロードマップ

### Phase 1: MVP (2-3 週間) ✅ 完了

- [x] Electron セットアップ
- [x] 基本的なファイル操作
- [x] CSV インポート・マッピング機能
- [ ] CSV-マークダウン紐付け機能
- [ ] マークダウンエディタ
- [x] 画像ギャラリー（グリッドビュー）
- [x] CSV 読み書き
- [x] 高度なフィルタリング機能（Phase 2 から前倒し実装）
- [x] バルク操作機能
- [x] 分析ダッシュボード（GitHub Issue #1）
- [x] UI/UX 改善（GitHub Issue #4）
- [x] バグ修正：ギャラリーページの無限再レンダリング（GitHub Issue #8）

### Phase 2: 機能拡張 (2-3 週間) ✅ 完了

- [x] 高度なフィルタリング（Phase 1 で実装済み）
- [x] 集計・分析機能
- [x] タイムラインビュー
- [x] ファイルシステム API 抽象化（GitHub Issue #5）
- [x] IPC 通信レイヤー設計（GitHub Issue #6）

### Phase 3: 最適化 (1-2 週間) ✅ Electron 統合完了

- [x] Electron 統合とデスクトップ機能（GitHub Issue #7）
- [x] UI/UX 改善
- [ ] パフォーマンス最適化
- [ ] 自動バックアップ（GitHub Issue #3 - 進行中）
- [ ] 設定画面

### Phase 4: CSV管理機能拡張 (1週間) ✅ 完了

- [x] CSV ビューア/エディタ機能（GitHub Issue #15）
- [x] 柔軟なCSVデータ管理（マッピング不要）
- [x] Excel ライクな編集機能
- [x] CSV文書管理システム
- [x] エクスポート機能（CSV/JSON）
- [x] ストレージ管理機能

## 8. 非機能要件

### 8.1 パフォーマンス

- 10,000 件の取引記録で快適動作
- 画像サムネイルの遅延読み込み
- インデックス化による高速検索

### 8.2 対応 OS

- Windows 10+
- macOS 10.15+
- Linux (Ubuntu 20.04+)

### 8.3 ハードウェア要件

- RAM: 4GB 以上推奨
- ストレージ: アプリ本体 100MB + ユーザーデータ

## 9. 現在の実装状況

### 実装済み機能

- ✅ Electron 統合（デスクトップアプリ化）
- ✅ セキュアな IPC 通信レイヤー
- ✅ ファイルシステム API 抽象化
- ✅ CSV インポート・表示機能
- ✅ 高度なフィルタリング・検索機能
- ✅ フィルタープリセット管理
- ✅ バルク操作（一括選択・削除・エクスポート）
- ✅ 分析ダッシュボード（チャート、統計情報）
- ✅ 画像ギャラリー（グリッドビュー）
- ✅ レスポンシブ UI/UX
- ✅ **CSV ビューア/エディタ**（Issue #15）
  - マッピング不要のCSVファイル表示・編集
  - Excel ライクなテーブル操作
  - 文書管理システム（複数CSV対応）
  - エクスポート機能（CSV/JSON）
  - ストレージ管理（10MB制限）

### 未実装機能

- ⏳ CSV-マークダウン紐付け機能
- ⏳ マークダウンエディタ
- ⏳ 自動バックアップ機能（Issue #3 で進行中）
- ⏳ 設定画面
- ⏳ パフォーマンス最適化

### 計画中機能

- 📋 **Enhanced Trade Import**（Issue #16）
  - フォーマット準拠 + カスタムカラム統合
  - 基本Trade型（analytics対応）+ ユーザーカスタムフィールド
  - CSV ViewerとTrade分析機能の統合

## 10. 将来的な拡張案

- プラグインシステム
- クラウド同期（オプション）
- モバイルビューア
- AI による取引分析（ローカル LLM）
- 仮想通貨・FX 対応
