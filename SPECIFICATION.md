# 投資記録管理アプリケーション仕様書

## 1. プロジェクト概要

### 1.1 アプリケーション名
Trade Journal Local (仮)

### 1.2 コンセプト
Obsidianのようなローカルファイルベースの投資記録管理システム。完全オフラインで動作し、プライバシーとセキュリティを重視したデスクトップアプリケーション。

### 1.3 主要機能
- ローカルマークダウンファイルでの投資記録管理
- 買い/売りのチャート画像を含む視覚的な記録
- CSV/Excelファイルでのポートフォリオ管理
- 画像一覧表示（グリッド/タイムライン切り替え可能）
- 高度なフィルタリング・集計機能

## 2. 技術スタック

### 2.1 フロントエンド
- **Next.js 15+** (App Router) - 最新の安定版
- **TypeScript** - 型安全性確保
- **Tailwind CSS 4.0+** - 最新のユーティリティファーストCSS
- **Shadcn/ui** (UIコンポーネント) - 最新のアクセシブルなReactコンポーネント

### 2.2 デスクトップ化
- **Electron 33+** (最新安定版) - セキュリティ強化とパフォーマンス改善
- **electron-builder** (パッケージング)

### 2.3 ライブラリ
- **@tanstack/react-table** (データテーブル) - 最新のテーブル管理
- **recharts** (グラフ表示) - React向けチャートライブラリ
- **react-markdown** (マークダウンレンダリング)
- **date-fns** (日付処理) - 軽量な日付ライブラリ
- **papaparse** (CSV処理) - 高速なCSVパーサー
- **exceljs** (Excel処理) - Excel読み書き対応

## 3. ディレクトリ構造

### 3.1 アプリケーション構造
```
trade-journal-local/
├── app/                    # Next.js App Router
│   ├── (main)/
│   │   ├── dashboard/     # ダッシュボード
│   │   ├── trades/        # トレード一覧・詳細
│   │   ├── gallery/       # 画像ギャラリー
│   │   ├── analytics/     # 分析・集計
│   │   └── import/        # CSVインポート画面
│   └── api/               # Electron IPC通信用
├── components/
│   ├── ui/                # Shadcn/ui components
│   ├── trade/
│   ├── gallery/
│   └── analytics/
├── electron/              # Electronメインプロセス
│   ├── main.ts
│   ├── preload.ts
│   └── ipc-handlers/
├── lib/
│   ├── file-system/       # ファイル操作
│   ├── parsers/           # CSV/Excel/MD解析
│   ├── csv-mapper/        # CSVマッピング処理
│   ├── trade-linker/      # CSV-MD紐付けロジック
│   └── utils/
└── types/
```

### 3.2 ユーザーデータ構造（推奨）
```
~/Documents/TradeJournal/  # ユーザーが変更可能
├── trades/
│   ├── 2024/
│   │   ├── 01/
│   │   │   ├── T001_AAPL_買い/
│   │   │   │   ├── entry_analysis.md
│   │   │   │   ├── technical_memo.md
│   │   │   │   ├── followup_20240116.md
│   │   │   │   └── images/
│   │   │   │       ├── chart_entry_1.png
│   │   │   │       ├── chart_entry_2.png
│   │   │   │       └── pattern_analysis.png
│   │   │   └── T002_AAPL_売り/
│   │   │       ├── exit_analysis.md
│   │   │       ├── reflection.md
│   │   │       └── images/
│   │   └── 02/
│   └── 2025/
├── portfolio/
│   ├── positions.csv      # 現在のポジション
│   ├── history.csv        # 取引履歴
│   └── watchlist.csv      # ウォッチリスト
├── templates/
│   ├── trade_buy.md       # 買いテンプレート
│   ├── trade_sell.md      # 売りテンプレート
│   └── analysis.md        # 分析テンプレート
└── .tradejournalrc        # アプリ設定ファイル
```

## 4. 機能詳細

### 4.1 トレード記録機能
- **新規記録作成**
  - テンプレートからの作成
  - CSVの選択した行から基本情報を取得
  - 「メモを追加」ボタンで新規マークダウン作成
  - 同一取引に複数のメモファイルを追加可能
  - ドラッグ&ドロップでの画像追加
  - マークダウンエディタでの詳細記述

- **記録管理**
  - フォルダ構造での整理（取引ごとにサブフォルダ）
  - 1つの取引フォルダ内に複数のマークダウンファイル保存
  - タグ・カテゴリ管理
  - 検索機能（全文検索対応）

### 4.2 画像ギャラリー機能
- **表示モード**
  - グリッドビュー（サムネイル一覧）
  - タイムラインビュー（時系列表示）
  - ペアビュー（買い/売りを並べて表示）

- **フィルタリング**
  - 期間指定
  - 銘柄フィルタ
  - 損益別（利益/損失）
  - タグフィルタ

### 4.3 ポートフォリオ管理
- **CSV/Excelファイル連携**
  - positions.csv: 銘柄、数量、平均取得価格、現在価格
  - history.csv: 日付、銘柄、売買、数量、価格、手数料、損益
  - カスタムフィールド対応

- **データインポート/エクスポート**
  - カスタムフォーマット対応
  - **ユーザーの既存CSVファイルの直接インポート**
  - **CSVカラムマッピング機能**（異なるフォーマットに対応）

- **CSVとマークダウンの紐付け機能**
  - CSVの各行に対して複数のマークダウンファイルを手動で紐付け可能
  - ユーザーがボタンを押して新規マークダウンを作成・追加
  - 1つの取引に対して複数のメモ・分析ファイルを関連付け可能
  - 既存のマークダウンファイルとの関連付け
  - 紐付けは手動で管理（自動生成なし）

### 4.4 分析・集計機能
- **パフォーマンス分析**
  - 期間別損益
  - 銘柄別パフォーマンス
  - 勝率・リスクリワード比

- **ビジュアライゼーション**
  - 損益推移グラフ
  - ポートフォリオ構成
  - ヒートマップ

### 4.5 設定・カスタマイズ
- **データ保存場所の指定**
- **テンプレートのカスタマイズ**
- **CSVフィールドマッピング**
- **ショートカットキー設定**

## 5. データ形式

### 5.1 マークダウンファイル形式
```markdown
---
date: 2024-01-15
ticker: AAPL
action: buy
quantity: 100
price: 185.50
tags: [テクノロジー, 長期投資]
---

# AAPL 買いエントリー

## エントリー理由
- サポートラインでの反発
- 出来高増加

## テクニカル分析
![チャート分析](./images/chart_entry.png)

## ファンダメンタル
- 新製品発表予定
- 業績好調

## リスク管理
- ストップロス: $180
- 目標価格: $200
```

### 5.2 CSV形式

#### 標準形式（history.csv）
```csv
trade_id,date,ticker,action,quantity,price,commission,pnl,notes_files
T001,2024-01-15,AAPL,buy,100,185.50,10.00,,"trades/2024/01/T001_AAPL_買い/entry_analysis.md,trades/2024/01/T001_AAPL_買い/technical_memo.md"
T002,2024-01-20,AAPL,sell,100,190.00,10.00,430.00,"trades/2024/01/T002_AAPL_売り/exit_analysis.md,trades/2024/01/T002_AAPL_売り/reflection.md"
```

#### ユーザーCSVマッピング例
```json
{
  "columnMapping": {
    "date": "取引日",
    "ticker": "銘柄コード",
    "action": "売買区分",
    "quantity": "数量",
    "price": "約定単価",
    "commission": "手数料",
    "pnl": "実現損益"
  },
  "dateFormat": "YYYY/MM/DD",
  "actionMapping": {
    "buy": ["買い", "現物買", "信用新規買"],
    "sell": ["売り", "現物売", "信用返済売"]
  }
}
```

## 6. セキュリティ・プライバシー

### 6.1 データ保護
- 完全オフライン動作
- ローカルファイルのみ使用
- 外部API通信なし（オプションで有効化可能）

### 6.2 バックアップ
- 自動バックアップ機能
- Git連携対応（オプション）
- 暗号化エクスポート

## 7. 開発ロードマップ

### Phase 1: MVP (2-3週間)
- [ ] Electronセットアップ
- [ ] 基本的なファイル操作
- [ ] CSVインポート・マッピング機能
- [ ] CSV-マークダウン紐付け機能
- [ ] マークダウンエディタ
- [ ] 画像ギャラリー（グリッドビュー）
- [ ] CSV読み書き

### Phase 2: 機能拡張 (2-3週間)
- [ ] 高度なフィルタリング
- [ ] 集計・分析機能
- [ ] タイムラインビュー
- [ ] Excel対応

### Phase 3: 最適化 (1-2週間)
- [ ] パフォーマンス最適化
- [ ] UI/UX改善
- [ ] 自動バックアップ
- [ ] 設定画面

## 8. 非機能要件

### 8.1 パフォーマンス
- 10,000件の取引記録で快適動作
- 画像サムネイルの遅延読み込み
- インデックス化による高速検索

### 8.2 対応OS
- Windows 10+
- macOS 10.15+
- Linux (Ubuntu 20.04+)

### 8.3 ハードウェア要件
- RAM: 4GB以上推奨
- ストレージ: アプリ本体100MB + ユーザーデータ

## 9. 将来的な拡張案
- プラグインシステム
- クラウド同期（オプション）
- モバイルビューア
- AIによる取引分析（ローカルLLM）
- 仮想通貨・FX対応